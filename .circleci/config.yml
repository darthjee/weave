version: 2
workflows:
  version: 2
  test:
    jobs:
      - pytest:
          filters:
            tags:
              only: /.*/
      - jasmine:
          filters:
            tags:
              only: /.*/
      - checks:
          filters:
            tags:
              only: /.*/
      - frontend-checks:
          filters:
            tags:
              only: /.*/
      - build-and-release:
          requires: [pytest, jasmine, frontend-checks, checks]
          filters:
            tags:
              only: /\d+\.\d+\.\d+/
            branches:
              ignore: /.*/
      - upload_fe_files:
          requires: [pytest, jasmine, frontend-checks, checks]
          filters:
            tags:
              only: /\d+\.\d+\.\d+/
            branches:
              ignore: /.*/
      - upload_proxy_files:
          requires: [pytest, jasmine, frontend-checks, checks]
          filters:
            tags:
              only: /\d+\.\d+\.\d+/
            branches:
              ignore: /.*/
      - release_static_files:
          requires: [build-and-release, upload_fe_files, upload_proxy_files]
          filters:
            tags:
              only: /\d+\.\d+\.\d+/
            branches:
              ignore: /.*/
jobs:
  pytest:
    docker:
      - image: darthjee/circleci_weave-base:0.0.4
        environment:
          WEAVE_MYSQL_HOST: mysql
          WEAVE_MYSQL_PORT: 3306
          WEAVE_MYSQL_USER: root
          WEAVE_MYSQL_NAME: weave
          WEAVE_MYSQL_PASSWORD: weave
      - image: cimg/mysql:8.0
        name: mysql
        environment:
          MYSQL_DATABASE: weave
          MYSQL_USER: weave
          MYSQL_PASSWORD: weave
          MYSQL_ROOT_PASSWORD: weave
    steps:
      - checkout
      - run:
          name: Set folder
          command: rm frontend static proxy -rf; cp backend/* ./ -r; rm backend -rf
      - run:
          name: Poetry Install
          command: poetry install --no-root --no-interaction --no-ansi
      - run:
          name: migrate
          command: bin/configure_database.sh all
      - run:
          name: Tests
          command: poetry run pytest

  jasmine:
    docker:
      - image: darthjee/circleci_node:0.2.1
    steps:
      - checkout
      - run:
          name: Set folder
          command: rm backend static proxy -rf; cp frontend/* frontend/.??* ./ -r; rm frontend -rf
      - run:
          name: Yarn install
          command: yarn install
      - run:
          name: Tests
          command: npm test

  checks:
    docker:
      - image: darthjee/circleci_weave-base:0.0.4
    steps:
      - checkout
      - run:
          name: Set folder
          command: rm frontend static proxy -rf; cp backend/* ./ -r; rm backend -rf
      - run:
          name: Poetry Install
          command: poetry install --no-root --no-interaction --no-ansi
      - run:
          name: Check python Lint
          command: poetry run ruff check . --fix
      - run:
          name: Check Python complexity
          command: bin/reports.sh ci
  frontend-checks:
    docker:
      - image: darthjee/circleci_node:0.2.1
    steps:
      - checkout
      - run:
          name: Set folder
          command: rm backend static proxy -rf; cp frontend/* frontend/.??* ./ -r; rm frontend -rf
      - run:
          name: Yarn install
          command: yarn install
      - run:
          name: Check JS Lint
          command: npm run lint
  build-and-release:
    machine: true
    steps:
      - checkout
      - run:
          name: Trigger Deploy
          command: scripts/deploy.sh deploy
  upload_fe_files:
    docker:
      - image: darthjee/vite_weave-base:0.0.4
    steps:
      - checkout
      - run:
          name: Set folder
          command: rm backend static proxy -rf; cp frontend/* frontend/.??* ./ -r; rm frontend -rf
      - run:
          name: Yarn install
          command: yarn install
      - run:
          name: Build assets
          command: deploy_frontend.sh build
      - run:
          name: Generate key file
          command: deploy_frontend.sh generate_key_file
      - run:
          name: Generate folder
          command: SSH_REMOTE_TEMP_DIR=$SSH_REMOTE_TEMP_DIR/static/ deploy_frontend.sh generate_folder
      - run:
          name: Upload assets
          command: SOURCE=dist/ SSH_REMOTE_TEMP_DIR=$SSH_REMOTE_TEMP_DIR/static/ deploy_frontend.sh upload
  upload_proxy_files:
    docker:
      - image: darthjee/tent:0.4.1
    workdir: /var/www/html
    steps:
      - checkout
      - run:
          name: Remove build images
          command: rm -f $(find proxy/source/static/assets/images/ -iname "*.pbm")
      - run:
          name: Generate key file
          command: deploy_frontend.sh generate_key_file
      - run:
          name: Upload proxy files
          command: SOURCE=/var/www/html/ deploy_frontend.sh upload
      - run:
          name: Upload assets
          command: SOURCE=proxy/ deploy_frontend.sh upload
      - run:
          name: Copy configuration files
          command: TARGET=configuration/ deploy_frontend.sh copy_files
  release_static_files:
    docker:
      - image: darthjee/vite_weave-base:0.0.4
    steps:
      - checkout
      - run:
          name: Generate key file
          command: deploy_frontend.sh generate_key_file
      - run:
          name: Release assets
          command: deploy_frontend.sh release

