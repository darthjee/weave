services:
  weave_mysql:
    image: mysql:9.3.0
    container_name: weave_mysql
    env_file: .env
    environment:
      MYSQL_ROOT_PASSWORD: weave
    ports:
      - 127.0.0.1:$WEAVE_MYSQL_PORT:3306

  weave_prod_mysql:
    image: mysql:9.3.0
    container_name: weave_prod_mysql
    env_file: .env.prod
    environment:
      MYSQL_ROOT_PASSWORD: weave

  #################### Base  ####################

  base: &base
    image: darthjee/weave
    volumes:
      - ./source:/home/app/app
    links:
      - weave_mysql:mysql
    env_file: .env

  base_build:
    <<: *base
    build:
      context: .
      dockerfile: Dockerfile.weave
    command: echo done

  base_prod: &base_prod
    <<: *base
    image: darthjee/production_weave
    links:
      - weave_prod_mysql:mysql
    env_file: .env.prod

  base_prod_build:
    <<: *base_prod
    build:
      context: .
      dockerfile: Dockerfile.production_weave
    command: echo done


  #################### CONTAINERS ####################

  weave_app: &weave_app
    <<: *base
    container_name: weave_app
    depends_on: [base_build, weave_mysql]
    ports:
      - 127.0.0.1:3000:8080
    environment:
      - WEAVE_MYSQL_PORT=3306

  weave_tests:
    <<: *base
    container_name: weave_tests
    depends_on: [base_build]

  weave_root:
    <<: *weave_app
    user: root
    command: /bin/bash

  weave_prod_app:
    <<: *base_prod
    container_name: weave_prod_app
    depends_on:
      - base_prod_build
      - weave_prod_mysql
      - weave_prod_static
      - weave_prod_ssh
    ports:
      - 127.0.0.1:3000:8080
    environment:
      - STAGE=production

  weave_prod_static:
    image: httpd:latest
    volumes:
      - ./httpd:/usr/local/apache2/htdocs
    ports:
      - 127.0.0.1:3001:80
  
  weave_prod_ssh:
    image: linuxserver/openssh-server
    container_name: weave_prod_ssh
    environment:
      - PUID=1000
      - PGID=1000
      - PUBLIC_KEY=ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOhux+BjquEbSALd4AC32vMX1hzYG/2JWuJpLF3yaDX+
    volumes:
      - ./httpd:/data
    restart: always
